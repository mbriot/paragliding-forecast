# vi .bash_profile -> PS1='\[\033[02;32m\]\u:\[\033[02;32m\]\w\$\[\033[00m\] '
# Install epel-repo puis python pip , puis ansible avec pip
# Remove vim which remove sudo, then install latest version
#sudo -i
#rpm -Uvh http://mirror.ghettoforge.org/distributions/gf/gf-release-latest.gf.el7.noarch.rpm
#rpm --import http://mirror.ghettoforge.org/distributions/gf/RPM-GPG-KEY-gf.el7
#
## WARNING: removing  vim-minimal uninstalls `sudo` if you skip the second step
##          make sure to at least run `yum install sudo`
#yum -y remove vim-minimal vim-common vim-enhanced
#yum -y --enablerepo=gf-plus install vim-enhanced sudo

- name: Install packages
  yum:
    name:
      - git
      - firefox
      - yum-utils
      - telnet
      - tcpdump
    state: present

- name: Add docker repo 
  yum_repository:
    name: docker
    description: Docker YUM repo
    baseurl: https://download.docker.com/linux/centos/docker-ce.repo
    enabled: yes

- name: Ugly fix to docker repo
  command: sed -i 's/docker-ce.repo/7\/x86_64\/stable/' /etc/yum.repos.d/docker.repo

- name: Install docker packages
  yum:
    name:
      - docker-ce 
      - docker-ce-cli 
      - containerd.io 
      - python-docker
    state: present

- name: Make sure docker is started
  systemd:
    state: started
    name: docker

- name: Create shared docker volume directory
  file:
    path: /home/centos/data/signal-cli
    state: directory
    mode: '0755'
    recurse: yes
    
#- name: Create a docker container
#  docker_container:
#    name: signal-api
#    image: bbernhard/signal-cli-rest-api:0.112-dev
#    published_ports: 8080:8080
#    restart_policy: always
#    volumes:
#      - /home/centos/data/signal-cli:/home/.local/share/signal-cli 
#    env:
#        MODE: native
#
# add ip tables rules based on this https://docs.docker.com/network/iptables/
- name: Create bin directory
  file:
    path: /home/centos/bin
    state: directory

- name: download geckodriver
  get_url: 
    url: https://github.com/mozilla/geckodriver/releases/download/v0.32.0/geckodriver-v0.32.0-linux64.tar.gz
    dest: /tmp

- name: Untar gecko
  unarchive:
    src: /tmp/geckodriver-v0.32.0-linux64.tar.gz
    dest: /home/centos/bin
    mode: +x

- name: add bin to path
  command: echo "export PATH=$PATH:/home/centos/bin" >> /home/centos/.bash_profile

- name: set timezone to Europe/Paris
  command: timedatectl set-timezone Europe/Paris

- name: Send to website from 8 to 16 h
  cron:
    name: "launch_predictions website 1"
    user: "centos"
    weekday: "*"
    minute: "0"
    hour: "8-16"
    job: "export PATH=$PATH:/home/centos/bin && ansible-playbook /home/centos/ansible/run.yml &>> /home/centos/log.log"
    state: present

- name: Send to website from 18 to 23 h
  cron:
    name: "launch_predictions website 2"
    user: "centos"
    weekday: "*"
    minute: "0"
    hour: "18-23"
    job: "export PATH=$PATH:/home/centos/bin && ansible-playbook /home/centos/ansible/run.yml &>> /home/centos/log.log"
    state: present

#- name: Send to Signal twice a day at 7 and 17 h
#  cron:
#    name: "launch_predictions website and signal"
#    user: "centos"
#    weekday: "*"
#    minute: "0"
#    hour: "7,17"
#    job: "export PATH=$PATH:/home/centos/bin && ansible-playbook /home/centos/ansible/run.yml -e'pythonArg=--send-to-signal --process-anyway' &>> /home/centos/log.log"
#    state: present